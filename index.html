<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á - Election Verification Dashboard</title>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea; --secondary: #764ba2; --danger: #f5576c;
            --warning: #ffc107; --success: #28a745; --info: #17a2b8;
            --bg: #f0f2f5; --card: #fff; --text: #333; --muted: #888;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); min-height: 100vh; color: var(--text); }
        a { color: var(--primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .top-bar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: #fff; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
        }
        .top-bar h1 { font-size: 1.4em; }
        .top-bar .links { display: flex; gap: 18px; font-size: .95em; }
        .top-bar .links a { color: rgba(255,255,255,.85); }
        .top-bar .links a:hover { color: #fff; }
        .top-bar .links a.active { color: #fff; font-weight: 700; border-bottom: 2px solid #fff; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Breadcrumb */
        .breadcrumb { display: flex; gap: 8px; align-items: center; margin-bottom: 18px; font-size: .95em; color: var(--muted); flex-wrap: wrap; }
        .breadcrumb span { cursor: pointer; color: var(--primary); }
        .breadcrumb span:hover { text-decoration: underline; }
        .breadcrumb .sep { color: #ccc; cursor: default; }
        .breadcrumb .current { color: var(--text); font-weight: 600; cursor: default; }

        /* Stats grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,.06); border-left: 4px solid var(--primary); }
        .stat-card .num { font-size: 1.8em; font-weight: 700; margin: 4px 0; }
        .stat-card .lbl { font-size: .82em; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
        .stat-card.green { border-color: var(--success); }
        .stat-card.blue { border-color: var(--info); }
        .stat-card.orange { border-color: var(--warning); }
        .stat-card.red { border-color: var(--danger); }

        /* Sections */
        .section { background: var(--card); border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
        .section h2 { color: var(--primary); margin-bottom: 16px; font-size: 1.2em; border-left: 4px solid var(--primary); padding-left: 12px; }

        /* Controls */
        .controls { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        select, input[type=text] { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: .95em; background: #fff; }
        select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,.15); }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: .95em; cursor: pointer; font-weight: 600; transition: all .2s; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: #fff; }
        .btn-sm { padding: 6px 14px; font-size: .85em; }

        /* Chart */
        .chart-container { position: relative; height: 380px; }

        /* Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: .92em; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; position: sticky; top: 0; }
        tr.clickable { cursor: pointer; }
        tr.clickable:hover { background: #f0f4ff; }

        /* Progress bar */
        .progress { background: #e9ecef; border-radius: 6px; height: 10px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 6px; transition: width .4s; }
        .progress-bar.green { background: var(--success); }
        .progress-bar.blue { background: var(--info); }
        .progress-bar.orange { background: var(--warning); }

        /* Candidate detail panel */
        .detail-panel { background: #f8f9fc; border: 1px solid #e0e3ea; border-radius: 10px; padding: 20px; margin-top: 10px; }
        .detail-panel h3 { margin-bottom: 12px; color: var(--secondary); }
        .cand-row { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .cand-row:last-child { border-bottom: none; }
        .cand-rank { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: .85em; color: #fff; flex-shrink: 0; }
        .cand-rank.r1 { background: #ffd700; color: #333; }
        .cand-rank.r2 { background: #c0c0c0; color: #333; }
        .cand-rank.r3 { background: #cd7f32; color: #fff; }
        .cand-rank.rn { background: #ddd; color: #666; }
        .cand-info { flex: 1; min-width: 0; }
        .cand-name { font-weight: 600; }
        .cand-party { font-size: .85em; color: var(--muted); }
        .cand-votes { text-align: right; font-weight: 600; white-space: nowrap; }
        .cand-bar { flex: 0 0 120px; }
        .cand-pct { font-size: .8em; color: var(--muted); text-align: right; }

        /* Zone tags */
        .zone-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .zone-tag { background: #e8ecf4; padding: 3px 10px; border-radius: 12px; font-size: .8em; color: #555; }

        /* Station info */
        .station-info { display: flex; gap: 24px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
        .station-info .item { display: flex; flex-direction: column; align-items: center; }
        .station-info .val { font-size: 1.4em; font-weight: 700; }
        .station-info .desc { font-size: .8em; color: var(--muted); }

        /* Alert banner */
        .alert-banner { padding: 14px 20px; border-radius: 8px; margin-bottom: 16px; font-size: .92em; }
        .alert-banner.info { background: #e3f2fd; color: #1565c0; }
        .alert-banner.warn { background: #fff8e1; color: #f57f17; }

        /* Map */
        .map-container { height: 450px; border-radius: 10px; overflow: hidden; }

        /* Footer */
        .footer { text-align: center; padding: 24px; color: var(--muted); font-size: .9em; margin-top: 30px; }
        .footer a { color: var(--primary); }

        @media (max-width: 768px) {
            .top-bar h1 { font-size: 1.1em; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 280px; }
            .cand-bar { display: none; }
        }
    </style>
</head>
<body>
    <!-- Top navigation bar -->
    <div class="top-bar">
        <h1>üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569</h1>
        <div class="links">
            <a href="index.html" class="active">Dashboard</a>
            <a href="compare.html">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡∏Å‡∏Å‡∏ï./Vote62</a>
        </div>
    </div>

    <div class="container">
        <!-- Update time -->
        <p id="lastUpdate" style="color:var(--muted);font-size:.85em;margin-bottom:12px;"></p>

        <!-- Breadcrumb navigation -->
        <div class="breadcrumb" id="breadcrumb">
            <span class="current">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</span>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="lbl">‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</div><div class="num" id="s-turnout">-</div></div>
            <div class="stat-card green"><div class="lbl">‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</div><div class="num" id="s-units">-</div></div>
            <div class="stat-card blue"><div class="lbl">‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div><div class="num" id="s-percent">-</div></div>
            <div class="stat-card orange"><div class="lbl">‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ</div><div class="num" id="s-valid">-</div></div>
            <div class="stat-card red"><div class="lbl">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ + ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</div><div class="num" id="s-invalid">-</div></div>
        </div>

        <!-- Controls -->
        <div class="section" id="controlSection">
            <div class="controls">
                <select id="provinceSelect" onchange="navigateProvince()">
                    <option value="all">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>
                </select>
                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Ç‡∏ï / ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£..." oninput="handleSearch()" style="flex:1;min-width:180px;">
                <button class="btn btn-primary" onclick="loadData()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn btn-outline" onclick="exportData()">üì• CSV</button>
            </div>
        </div>

        <!-- Alert: station data not yet available -->
        <div class="alert-banner info" id="stationAlert">
            ‚ÑπÔ∏è <strong>‡∏Å‡∏Å‡∏ï. ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</strong> ‚Äî ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï (400 ‡πÄ‡∏Ç‡∏ï) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
        </div>

        <!-- Charts (only on national view) -->
        <div id="chartsArea">
            <div class="section">
                <h2>üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ (Top 10)</h2>
                <div class="chart-container"><canvas id="overviewChart"></canvas></div>
            </div>
            <div class="section">
                <h2>üèõÔ∏è ‡πÄ‡∏Ç‡∏ï vs ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h2>
                <div class="chart-container"><canvas id="partyChart"></canvas></div>
            </div>
        </div>

        <!-- Main data area (table / detail) -->
        <div class="section" id="dataSection">
            <h2 id="dataTitle">üìã ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</h2>
            <div id="dataContent">
                <!-- dynamic content -->
            </div>
        </div>

        <!-- Map -->
        <div class="section">
            <h2>üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</h2>
            <div class="map-container" id="map"></div>
        </div>
    </div>

    <div class="footer">
        <p>Election Verification System &middot; #‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</p>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å <a href="https://ectreport69.ect.go.th" target="_blank">‡∏Å‡∏Å‡∏ï.</a> | ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö <a href="https://vote62.com" target="_blank">Vote62.com</a></p>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let map, charts = {}, data = null;
        // view: 'national' | 'province' | 'constituency'
        let view = 'national';
        let selectedProvId = null;
        let selectedUnitId = null;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', () => { initMap(); loadData(); });

        function loadData() {
            fetch('data/election_data.json')
                .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(json => {
                    data = json;
                    populateProvinceFilter();
                    showNational();
                })
                .catch(err => {
                    document.getElementById('lastUpdate').textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message;
                });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Province dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function populateProvinceFilter() {
            const sel = document.getElementById('provinceSelect');
            sel.innerHTML = '<option value="all">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';
            if (!data || !data.provinces) return;
            Object.values(data.provinces)
                .sort((a, b) => a.name.localeCompare(b.name, 'th'))
                .forEach(p => {
                    const o = document.createElement('option');
                    o.value = p.prov_id;
                    o.textContent = p.name + ' (' + p.units + ' ‡πÄ‡∏Ç‡∏ï)';
                    sel.appendChild(o);
                });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function navigateProvince() {
            const v = document.getElementById('provinceSelect').value;
            if (v === 'all') { showNational(); return; }
            selectedProvId = v;
            showProvince(v);
        }

        function showNational() {
            view = 'national'; selectedProvId = null; selectedUnitId = null;
            document.getElementById('provinceSelect').value = 'all';
            updateBreadcrumb();
            updateStats();
            updateCharts();
            document.getElementById('chartsArea').style.display = '';
            renderNationalTable();
        }

        function showProvince(provId) {
            view = 'province'; selectedProvId = provId; selectedUnitId = null;
            document.getElementById('provinceSelect').value = provId;
            updateBreadcrumb();
            updateStatsProvince(provId);
            document.getElementById('chartsArea').style.display = 'none';
            renderProvinceTable(provId);
        }

        function showConstituency(unitId) {
            view = 'constituency'; selectedUnitId = unitId;
            const unit = data.units.find(u => u.unit_id === unitId);
            if (!unit) return;
            selectedProvId = unit.prov_id;
            document.getElementById('provinceSelect').value = unit.prov_id;
            updateBreadcrumb();
            updateStatsUnit(unit);
            document.getElementById('chartsArea').style.display = 'none';
            renderConstituencyDetail(unit);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Breadcrumb ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateBreadcrumb() {
            const bc = document.getElementById('breadcrumb');
            let html = '';
            if (view === 'national') {
                html = '<span class="current">üáπüá≠ ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</span>';
            } else if (view === 'province') {
                const prov = data.provinces[selectedProvId];
                html = `<span onclick="showNational()">üáπüá≠ ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</span><span class="sep">‚Ä∫</span>`;
                html += `<span class="current">${prov ? prov.name : selectedProvId}</span>`;
            } else {
                const prov = data.provinces[selectedProvId];
                const unit = data.units.find(u => u.unit_id === selectedUnitId);
                html = `<span onclick="showNational()">üáπüá≠ ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</span><span class="sep">‚Ä∫</span>`;
                html += `<span onclick="showProvince('${selectedProvId}')">${prov ? prov.name : selectedProvId}</span><span class="sep">‚Ä∫</span>`;
                html += `<span class="current">${unit ? unit.constituency : selectedUnitId}</span>`;
            }
            bc.innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateStats() {
            const ns = data.metadata.national_stats || {};
            setStats(ns.turn_out, data.metadata.total_units, ns.percent_count, ns.valid_votes, (ns.invalid_votes||0) + (ns.blank_votes||0));
            if (data.metadata.last_update) {
                document.getElementById('lastUpdate').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date(data.metadata.last_update).toLocaleString('th-TH');
            }
        }
        function updateStatsProvince(provId) {
            const p = data.provinces[provId];
            if (!p) return;
            const units = data.units.filter(u => u.prov_id === provId);
            const inv = units.reduce((s,u)=>(s+(u.invalid_votes||0)+(u.blank_votes||0)),0);
            setStats(p.turn_out, p.units, p.percent_count, p.valid_votes, inv);
        }
        function updateStatsUnit(u) {
            setStats(u.turn_out, u.total_stations + ' ‡∏´‡∏ô‡πà‡∏ß‡∏¢', u.percent_count, u.valid_votes, (u.invalid_votes||0) + (u.blank_votes||0));
        }
        function setStats(turnout, units, pct, valid, invalid) {
            document.getElementById('s-turnout').textContent = typeof turnout === 'number' ? turnout.toLocaleString() : '-';
            document.getElementById('s-units').textContent = typeof units === 'number' ? units.toLocaleString() : units;
            document.getElementById('s-percent').textContent = typeof pct === 'number' ? pct.toFixed(2) + '%' : '-';
            document.getElementById('s-valid').textContent = typeof valid === 'number' ? valid.toLocaleString() : '-';
            document.getElementById('s-invalid').textContent = typeof invalid === 'number' ? invalid.toLocaleString() : '-';
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateCharts() {
            createOverviewChart();
            createPartyChart();
        }
        function createOverviewChart() {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            if (charts.overview) charts.overview.destroy();
            const np = data.national_parties || [];
            charts.overview = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: np.map(p => p.name),
                    datasets: [{ label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ç‡∏ï', data: np.map(p => p.cons_votes), backgroundColor: np.map(p => p.color || '#667eea') }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ (‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á) - Top 10' } },
                    scales: { x: { beginAtZero: true, ticks: { callback: v => (v/1e6).toFixed(1)+'M' } } }
                }
            });
        }
        function createPartyChart() {
            const ctx = document.getElementById('partyChart').getContext('2d');
            if (charts.party) charts.party.destroy();
            const np = data.national_parties || [];
            charts.party = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: np.map(p => p.name),
                    datasets: [
                        { label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ç‡∏ï', data: np.map(p => p.cons_votes), backgroundColor: 'rgba(102,126,234,.8)' },
                        { label: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠', data: np.map(p => p.party_list_votes), backgroundColor: 'rgba(245,87,108,.8)' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: true, text: '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ç‡∏ï vs ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠' } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => (v/1e6).toFixed(1)+'M' } } }
                }
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ National table (provinces) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderNationalTable() {
            document.getElementById('dataTitle').textContent = 'üìã ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (77 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)';
            const provs = Object.values(data.provinces).sort((a,b) => a.name.localeCompare(b.name, 'th'));
            let html = `<div class="table-responsive"><table>
                <thead><tr>
                    <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</th><th>‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ</th>
                    <th>‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th><th>‡∏û‡∏£‡∏£‡∏Ñ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1</th>
                </tr></thead><tbody>`;
            provs.forEach(p => {
                const top = (p.top_parties && p.top_parties[0]) ? p.top_parties[0] : null;
                const pctBar = ((p.counted_stations || 0) / Math.max(p.total_stations || 1, 1) * 100);
                html += `<tr class="clickable" onclick="showProvince('${p.prov_id}')">
                    <td><strong>${p.name}</strong></td>
                    <td>${p.units}</td>
                    <td>${(p.turn_out||0).toLocaleString()}</td>
                    <td>${(p.valid_votes||0).toLocaleString()}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="progress" style="flex:1;"><div class="progress-bar ${pctBar>=95?'green':pctBar>=80?'blue':'orange'}" style="width:${pctBar.toFixed(1)}%"></div></div>
                            <span style="font-size:.8em;white-space:nowrap;">${(p.counted_stations||0)}/${p.total_stations||'?'}</span>
                        </div>
                    </td>
                    <td>${top ? `<span style="color:${top.color};font-weight:600">${top.name}</span>` : '-'}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('dataContent').innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Province table (constituencies) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderProvinceTable(provId) {
            const prov = data.provinces[provId];
            const units = data.units.filter(u => u.prov_id === provId).sort((a,b) => {
                const na = parseInt(a.unit_id.split('_')[1]); const nb = parseInt(b.unit_id.split('_')[1]);
                return na - nb;
            });
            document.getElementById('dataTitle').textContent = `üìã ${prov ? prov.name : provId} ‚Äî ${units.length} ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á`;
            let html = `<div class="table-responsive"><table>
                <thead><tr>
                    <th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                    <th>‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th>
                </tr></thead><tbody>`;
            units.forEach(u => {
                const pctSt = u.total_stations ? (u.counted_stations / u.total_stations * 100) : 0;
                const zoneStr = (u.zone || []).slice(0, 3).join(', ') + ((u.zone||[]).length > 3 ? '...' : '');
                html += `<tr class="clickable" onclick="showConstituency('${u.unit_id}')">
                    <td><strong>‡πÄ‡∏Ç‡∏ï ${u.unit_id.split('_')[1]}</strong></td>
                    <td style="font-size:.85em;color:var(--muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(u.zone||[]).join(', ')}">${zoneStr || '-'}</td>
                    <td><span style="color:${u.winner_color||'inherit'};font-weight:600">${u.winner || '-'}</span></td>
                    <td>${(u.winner_votes||0).toLocaleString()}</td>
                    <td>${(u.turn_out||0).toLocaleString()}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="progress" style="flex:1;max-width:100px;"><div class="progress-bar ${pctSt>=95?'green':pctSt>=80?'blue':'orange'}" style="width:${pctSt.toFixed(1)}%"></div></div>
                            <span style="font-size:.8em;white-space:nowrap;">${u.counted_stations}/${u.total_stations||'?'}</span>
                        </div>
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('dataContent').innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Constituency detail (candidates) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderConstituencyDetail(u) {
            document.getElementById('dataTitle').textContent = `üìã ${u.constituency}`;
            const cands = u.candidates || u.parties || [];
            const maxVote = cands.length > 0 ? Math.max(...cands.map(c => c.ect_votes || c.ect || 0)) : 1;

            let html = '';
            // Station info
            const pctSt = u.total_stations ? (u.counted_stations / u.total_stations * 100) : 0;
            html += `<div class="station-info">
                <div class="item"><div class="val">${u.counted_stations}</div><div class="desc">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div></div>
                <div class="item"><div class="val">${u.total_stations || '?'}</div><div class="desc">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                <div class="item"><div class="val">${pctSt.toFixed(1)}%</div><div class="desc">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div></div>
                <div class="item"><div class="val">${(u.registered_vote||0).toLocaleString()}</div><div class="desc">‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</div></div>
                <div class="item"><div class="val">${(u.turn_out||0).toLocaleString()}</div><div class="desc">‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</div></div>
                <div class="item"><div class="val">${(u.percent_turn_out||0).toFixed(1)}%</div><div class="desc">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</div></div>
            </div>`;

            // Progress bar
            html += `<div style="margin:10px 0 20px;"><div class="progress" style="height:14px;">
                <div class="progress-bar ${pctSt>=95?'green':pctSt>=80?'blue':'orange'}" style="width:${pctSt.toFixed(1)}%"></div>
            </div></div>`;

            // Zone tags
            if (u.zone && u.zone.length > 0) {
                html += `<div style="margin-bottom:16px;"><strong style="font-size:.9em;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong><div class="zone-tags">`;
                u.zone.forEach(z => { html += `<span class="zone-tag">${z}</span>`; });
                html += '</div></div>';
            }

            // Candidate list
            html += `<div class="detail-panel"><h3>‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (${cands.length} ‡∏Ñ‡∏ô)</h3>`;
            cands.forEach((c, i) => {
                const votes = c.ect_votes || c.ect || 0;
                const name = c.name || c.candidate_name || '';
                const party = c.party || c.name || '';
                const color = c.party_color || c.color || '#999';
                const pct = c.percent || 0;
                const barW = maxVote > 0 ? (votes / maxVote * 100) : 0;
                const rankClass = i === 0 ? 'r1' : i === 1 ? 'r2' : i === 2 ? 'r3' : 'rn';

                html += `<div class="cand-row">
                    <div class="cand-rank ${rankClass}">${i+1}</div>
                    <div class="cand-info">
                        <div class="cand-name">${name || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)'}</div>
                        <div class="cand-party"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-right:4px;"></span>${party}${c.number ? ' #'+c.number : ''}</div>
                    </div>
                    <div class="cand-bar">
                        <div class="progress" style="height:8px;"><div class="progress-bar" style="width:${barW.toFixed(1)}%;background:${color};"></div></div>
                    </div>
                    <div class="cand-votes">${votes.toLocaleString()}<div class="cand-pct">${pct.toFixed(1)}%</div></div>
                </div>`;
            });
            html += '</div>';

            // Vote summary table
            html += `<div style="margin-top:16px;font-size:.9em;">
                <table style="max-width:400px;">
                    <tr><td>‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ</td><td style="text-align:right;font-weight:600;">${(u.valid_votes||0).toLocaleString()}</td></tr>
                    <tr><td>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢</td><td style="text-align:right;font-weight:600;">${(u.invalid_votes||0).toLocaleString()}</td></tr>
                    <tr><td>‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</td><td style="text-align:right;font-weight:600;">${(u.blank_votes||0).toLocaleString()}</td></tr>
                    <tr style="border-top:2px solid #333;"><td><strong>‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</strong></td><td style="text-align:right;font-weight:700;">${(u.turn_out||0).toLocaleString()}</td></tr>
                </table>
            </div>`;

            document.getElementById('dataContent').innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function handleSearch() {
            const q = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!q) {
                if (view === 'national') renderNationalTable();
                else if (view === 'province') renderProvinceTable(selectedProvId);
                return;
            }
            // Search across all units
            const results = data.units.filter(u => {
                if (u.constituency.toLowerCase().includes(q)) return true;
                if (u.province.toLowerCase().includes(q)) return true;
                if (u.unit_id.toLowerCase().includes(q)) return true;
                if (u.winner && u.winner.toLowerCase().includes(q)) return true;
                if (u.candidates) {
                    for (const c of u.candidates) {
                        if (c.name && c.name.toLowerCase().includes(q)) return true;
                    }
                }
                return false;
            });
            renderSearchResults(results, q);
        }
        function renderSearchResults(results, q) {
            document.getElementById('dataTitle').textContent = `üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${q}" ‚Äî ‡∏û‡∏ö ${results.length} ‡πÄ‡∏Ç‡∏ï`;
            let html = `<div class="table-responsive"><table>
                <thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th></tr></thead><tbody>`;
            results.forEach(u => {
                html += `<tr class="clickable" onclick="showConstituency('${u.unit_id}')">
                    <td><strong>${u.constituency}</strong></td>
                    <td>${u.province}</td>
                    <td><span style="color:${u.winner_color||'inherit'};font-weight:600">${u.winner||'-'}</span></td>
                    <td>${(u.winner_votes||0).toLocaleString()}</td>
                    <td>${(u.percent_count||0).toFixed(1)}%</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('dataContent').innerHTML = html;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function exportData() {
            if (!data) return;
            const units = view === 'province' ? data.units.filter(u => u.prov_id === selectedProvId) : data.units;
            const headers = ['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡∏ï','‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î','‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞','‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞','‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥','‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ','‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢','‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß(%)','‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß','‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'];
            const rows = units.map(u => [
                u.unit_id, '"'+u.constituency+'"', '"'+u.province+'"', '"'+(u.winner||'')+'"',
                u.winner_votes||0, u.turn_out||0, u.valid_votes||0, u.invalid_votes||0,
                (u.percent_count||0).toFixed(1), u.counted_stations||0, u.total_stations||0
            ]);
            let csv = headers.join(',')+'\n';
            rows.forEach(r => { csv += r.join(',')+'\n'; });
            const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'election_'+new Date().toISOString().split('T')[0]+'.csv';
            a.click();
        }
    </script>
</body>
</html>
