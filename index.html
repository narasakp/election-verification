<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á - Election Verification Dashboard</title>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --danger: #f5576c;
            --warning: #ffc107;
            --success: #28a745;
            --info: #17a2b8;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card.identical .number { color: var(--success); }
        .stat-card.minor .number { color: var(--warning); }
        .stat-card.significant .number { color: #ff6b6b; }
        .stat-card.critical .number { color: var(--danger); }
        
        .viz-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .viz-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            padding-left: 15px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        
        .map-container {
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        select, input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: var(--info);
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning);
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }
        
        .table-responsive {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-critical { background: var(--danger); color: white; }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            color: white;
            margin-top: 50px;
        }
        
        .footer a {
            color: white;
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2026</h1>
            <p>Election Verification Dashboard - ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏Å‡∏ï. vs Vote62.com</p>
        </div>
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card identical">
                <div class="icon">‚úÖ</div>
                <div class="number" id="stat-identical">0</div>
                <div class="label">‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞</div>
            </div>
            <div class="stat-card minor">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="number" id="stat-minor">0</div>
                <div class="label">‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</div>
            </div>
            <div class="stat-card significant">
                <div class="icon">üö®</div>
                <div class="number" id="stat-significant">0</div>
                <div class="label">‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å</div>
            </div>
            <div class="stat-card critical">
                <div class="icon">üî¥</div>
                <div class="number" id="stat-critical">0</div>
                <div class="label">‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á</div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="viz-section">
            <h2>üéõÔ∏è ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h2>
            <div class="controls">
                <select id="provinceSelect">
                    <option value="all">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                    <option value="bangkok">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</option>
                    <option value="chiangmai">‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</option>
                    <option value="phuket">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
                </select>
                
                <select id="chartType">
                    <option value="overview">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</option>
                    <option value="comparison">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ</option>
                    <option value="timeline">Timeline</option>
                    <option value="heatmap">Heatmap</option>
                </select>
                
                <button class="btn btn-primary" onclick="loadData()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="btn btn-primary" onclick="exportData()">üì• Export CSV</button>
            </div>
            
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô GitHub Pages 
                (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ push ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà)
            </div>
        </div>
        
        <!-- Chart: Overview -->
        <div class="viz-section">
            <h2>üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h2>
            <div class="chart-container">
                <canvas id="overviewChart"></canvas>
            </div>
        </div>
        
        <!-- Chart: Party Comparison -->
        <div class="viz-section">
            <h2>üèõÔ∏è ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ</h2>
            <div class="chart-container">
                <canvas id="partyChart"></canvas>
            </div>
        </div>
        
        <!-- Chart: Discrepancy Distribution -->
        <div class="viz-section">
            <h2>üìà ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á</h2>
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
        
        <!-- Map -->
        <div class="viz-section">
            <h2>üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</h2>
            <div class="map-container" id="map"></div>
        </div>
        
        <!-- Detailed Results Table -->
        <div class="viz-section">
            <h2>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h2>
            <div class="table-responsive">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th>‡πÄ‡∏Ç‡∏ï</th>
                            <th>‡∏Å‡∏Å‡∏ï.</th>
                            <th>Vote62</th>
                            <th>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Critical Units Alert -->
        <div id="criticalAlert" style="display:none;">
            <div class="viz-section">
                <div class="alert alert-danger">
                    <h3 style="margin-bottom: 15px;">üö® ‡∏û‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á!</h3>
                    <div id="criticalList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ Election Verification System Team</p>
        <p>#‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® #‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô</p>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å: <a href="https://www.ect.go.th">‡∏Å‡∏Å‡∏ï.</a> ‡πÅ‡∏•‡∏∞ <a href="https://vote62.com">Vote62.com</a></p>
    </div>

    <script>
        // Global variables
        let map;
        let charts = {};
        let data = null;
        
        // Sample data structure (will be loaded from JSON file)
        const sampleData = {
            metadata: {
                last_update: "2026-02-12T15:30:00",
                total_units: 31200,
                compared_units: 5000
            },
            statistics: {
                identical: 4200,
                minor: 500,
                significant: 250,
                critical: 50
            },
            units: [
                {
                    unit_id: "001001",
                    constituency: "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ ‡πÄ‡∏Ç‡∏ï 1",
                    province: "bangkok",
                    ect_total: 3550,
                    vote62_total: 3550,
                    difference: 0,
                    level: "identical",
                    lat: 13.7563,
                    lng: 100.5018,
                    parties: [
                        { name: "‡∏û‡∏£‡∏£‡∏Ñ A", ect: 1500, vote62: 1500 },
                        { name: "‡∏û‡∏£‡∏£‡∏Ñ B", ect: 1200, vote62: 1200 },
                        { name: "‡∏û‡∏£‡∏£‡∏Ñ C", ect: 800, vote62: 800 }
                    ]
                },
                {
                    unit_id: "001002",
                    constituency: "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ ‡πÄ‡∏Ç‡∏ï 1",
                    province: "bangkok",
                    ect_total: 3680,
                    vote62_total: 3550,
                    difference: 130,
                    level: "critical",
                    lat: 13.7600,
                    lng: 100.5100,
                    parties: [
                        { name: "‡∏û‡∏£‡∏£‡∏Ñ A", ect: 1630, vote62: 1500 },
                        { name: "‡∏û‡∏£‡∏£‡∏Ñ B", ect: 1200, vote62: 1200 },
                        { name: "‡∏û‡∏£‡∏£‡∏Ñ C", ect: 850, vote62: 850 }
                    ]
                }
                // More units...
            ]
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadData();
        });
        
        // Load data (from JSON file or sample data)
        function loadData() {
            // In production, load from: fetch('data/election_data.json')
            // For now, use sample data
            data = sampleData;
            updateUI();
        }
        
        // Update all UI components
        function updateUI() {
            if (!data) return;
            
            updateStats();
            updateCharts();
            updateMap();
            updateTable();
            checkCriticalUnits();
        }
        
        // Update statistics cards
        function updateStats() {
            document.getElementById('stat-identical').textContent = 
                data.statistics.identical.toLocaleString();
            document.getElementById('stat-minor').textContent = 
                data.statistics.minor.toLocaleString();
            document.getElementById('stat-significant').textContent = 
                data.statistics.significant.toLocaleString();
            document.getElementById('stat-critical').textContent = 
                data.statistics.critical.toLocaleString();
        }
        
        // Update charts
        function updateCharts() {
            createOverviewChart();
            createPartyChart();
            createDistributionChart();
        }
        
        // Overview Chart
        function createOverviewChart() {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            
            if (charts.overview) {
                charts.overview.destroy();
            }
            
            charts.overview = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‚úÖ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞', '‚ö†Ô∏è ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢', 
                             'üö® ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å', 'üî¥ ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á'],
                    datasets: [{
                        data: [
                            data.statistics.identical,
                            data.statistics.minor,
                            data.statistics.significant,
                            data.statistics.critical
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#ff6b6b',
                            '#f5576c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö'
                        }
                    }
                }
            });
        }
        
        // Party Comparison Chart
        function createPartyChart() {
            const ctx = document.getElementById('partyChart').getContext('2d');
            
            if (charts.party) {
                charts.party.destroy();
            }
            
            // Aggregate party data
            const partyData = {};
            data.units.forEach(unit => {
                unit.parties.forEach(party => {
                    if (!partyData[party.name]) {
                        partyData[party.name] = { ect: 0, vote62: 0 };
                    }
                    partyData[party.name].ect += party.ect;
                    partyData[party.name].vote62 += party.vote62;
                });
            });
            
            const labels = Object.keys(partyData);
            const ectData = labels.map(name => partyData[name].ect);
            const vote62Data = labels.map(name => partyData[name].vote62);
            
            charts.party = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡∏Å‡∏Å‡∏ï.',
                            data: ectData,
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'Vote62',
                            data: vote62Data,
                            backgroundColor: '#f5576c'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏û‡∏£‡∏£‡∏Ñ'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Distribution Chart
        function createDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (charts.distribution) {
                charts.distribution.destroy();
            }
            
            // Create histogram of differences
            const differences = data.units.map(u => u.difference);
            const bins = [0, 10, 50, 100, 200, 500, Infinity];
            const counts = new Array(bins.length - 1).fill(0);
            
            differences.forEach(diff => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (diff >= bins[i] && diff < bins[i + 1]) {
                        counts[i]++;
                        break;
                    }
                }
            });
            
            charts.distribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-10', '10-50', '50-100', '100-200', '200-500', '500+'],
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢',
                        data: counts,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)'
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        // Update map with markers
        function updateMap() {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            // Add markers for each unit
            data.units.forEach(unit => {
                if (unit.lat && unit.lng) {
                    const color = unit.level === 'critical' ? 'red' :
                                 unit.level === 'significant' ? 'orange' :
                                 unit.level === 'minor' ? 'yellow' : 'green';
                    
                    const marker = L.circleMarker([unit.lat, unit.lng], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢ ${unit.unit_id}</strong><br>
                        ${unit.constituency}<br>
                        <hr>
                        ‡∏Å‡∏Å‡∏ï.: ${unit.ect_total.toLocaleString()}<br>
                        Vote62: ${unit.vote62_total.toLocaleString()}<br>
                        ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á: ${unit.difference.toLocaleString()}<br>
                        <strong style="color: ${color}">${getLevelText(unit.level)}</strong>
                    `);
                }
            });
        }
        
        // Update table
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.units.forEach(unit => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${unit.unit_id}</td>
                    <td>${unit.constituency}</td>
                    <td>${unit.ect_total.toLocaleString()}</td>
                    <td>${unit.vote62_total.toLocaleString()}</td>
                    <td>${unit.difference.toLocaleString()}</td>
                    <td><span class="badge badge-${unit.level}">${getLevelText(unit.level)}</span></td>
                `;
            });
        }
        
        // Check for critical units
        function checkCriticalUnits() {
            const critical = data.units.filter(u => u.level === 'critical');
            
            if (critical.length > 0) {
                document.getElementById('criticalAlert').style.display = 'block';
                const list = document.getElementById('criticalList');
                list.innerHTML = '<ul>' + critical.map(u => 
                    `<li><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢ ${u.unit_id}</strong> (${u.constituency}): 
                     ‡∏ï‡πà‡∏≤‡∏á ${u.difference.toLocaleString()} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</li>`
                ).join('') + '</ul>';
            }
        }
        
        // Helper function
        function getLevelText(level) {
            const map = {
                'identical': '‚úÖ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞',
                'minor': '‚ö†Ô∏è ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
                'significant': 'üö® ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å',
                'critical': 'üî¥ ‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á'
            };
            return map[level] || level;
        }
        
        // Export data
        function exportData() {
            if (!data) return;
            
            // Convert to CSV
            const headers = ['‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡πÄ‡∏Ç‡∏ï', '‡∏Å‡∏Å‡∏ï.', 'Vote62', '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
            const rows = data.units.map(u => [
                u.unit_id,
                u.constituency,
                u.ect_total,
                u.vote62_total,
                u.difference,
                getLevelText(u.level)
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.join(',') + '\n';
            });
            
            // Download
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'election_verification_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
