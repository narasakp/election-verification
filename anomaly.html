<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ - Election Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#667eea;--secondary:#764ba2;--danger:#f5576c;--warning:#ffc107;--success:#28a745;--info:#17a2b8;--bg:#f0f2f5;--card:#fff;--text:#333;--muted:#888}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);min-height:100vh;color:var(--text)}
        a{color:var(--primary);text-decoration:none}a:hover{text-decoration:underline}
        .top-bar{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:#fff;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
        .top-bar h1{font-size:1.4em}.top-bar .links{display:flex;gap:18px;font-size:.95em}
        .top-bar .links a{color:rgba(255,255,255,.85)}.top-bar .links a:hover{color:#fff}
        .top-bar .links a.active{color:#fff;font-weight:700;border-bottom:2px solid #fff}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        .section{background:var(--card);border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .section h2{color:var(--primary);margin-bottom:16px;font-size:1.15em;border-left:4px solid var(--primary);padding-left:12px}
        .section h3{color:var(--secondary);margin:16px 0 10px;font-size:1em}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
        @media(max-width:900px){.grid2,.grid3{grid-template-columns:1fr}}

        /* Summary cards */
        .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px}
        .s-card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.05);text-align:center;border-top:4px solid var(--primary)}
        .s-card .num{font-size:1.9em;font-weight:700;margin:4px 0}
        .s-card .lbl{font-size:.78em;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
        .s-card.red{border-color:var(--danger)}.s-card.red .num{color:var(--danger)}
        .s-card.orange{border-color:var(--warning)}.s-card.orange .num{color:#e65100}
        .s-card.green{border-color:var(--success)}.s-card.green .num{color:var(--success)}
        .s-card.blue{border-color:var(--info)}.s-card.blue .num{color:var(--info)}

        .chart-container{position:relative;height:340px;margin-bottom:10px}
        .chart-sm{height:260px}

        /* Flag table */
        .table-responsive{overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:.88em}
        th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #eee}
        th{background:#f8f9fa;font-weight:600;color:#555;position:sticky;top:0}
        tr:hover{background:#f8f9fc}
        .badge{display:inline-block;padding:3px 10px;border-radius:14px;font-size:.78em;font-weight:600}
        .badge-high{background:#f8d7da;color:#721c24}.badge-medium{background:#fff3cd;color:#856404}
        .badge-low{background:#d4edda;color:#155724}.badge-info{background:#e3f2fd;color:#1565c0}

        /* Stat box */
        .stat-box{background:#f8f9fc;border-radius:8px;padding:14px;margin:6px 0;border-left:3px solid var(--primary)}
        .stat-box .key{font-size:.82em;color:var(--muted)}.stat-box .val{font-size:1.1em;font-weight:600}

        /* Tabs */
        .tabs{display:flex;gap:0;border-bottom:2px solid #e0e0e0;margin-bottom:20px;flex-wrap:wrap}
        .tab{padding:10px 20px;cursor:pointer;font-weight:600;font-size:.92em;color:var(--muted);border-bottom:3px solid transparent;transition:all .2s}
        .tab:hover{color:var(--primary)}.tab.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab-panel{display:none}.tab-panel.active{display:block}

        .verdict{padding:16px 20px;border-radius:10px;margin-bottom:16px;font-size:.95em}
        .verdict.pass{background:#e8f5e9;color:#2e7d32;border-left:5px solid var(--success)}
        .verdict.fail{background:#fce4ec;color:#c62828;border-left:5px solid var(--danger)}
        .verdict.warn{background:#fff8e1;color:#f57f17;border-left:5px solid var(--warning)}

        .footer{text-align:center;padding:24px;color:var(--muted);font-size:.9em;margin-top:30px}
        .footer a{color:var(--primary)}
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>üî¨ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</h1>
        <div class="links">
            <a href="index.html">Dashboard</a>
            <a href="compare.html">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</a>
            <a href="anomaly.html" class="active">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</a>
        </div>
    </div>

    <div class="container">
        <!-- Executive summary -->
        <div class="section" id="execSummary">
            <h2>üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
            <div class="summary-grid" id="summaryCards"></div>
            <div id="verdictArea"></div>
        </div>

        <!-- Tabs -->
        <div class="section">
            <div class="tabs" id="mainTabs">
                <div class="tab active" data-tab="turnout">‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</div>
                <div class="tab" data-tab="invalid">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢</div>
                <div class="tab" data-tab="blank">‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø</div>
                <div class="tab" data-tab="wasted">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>
                <div class="tab" data-tab="dominance">‡∏ä‡∏ô‡∏∞‡∏Ç‡∏≤‡∏î‡∏•‡∏≠‡∏¢</div>
                <div class="tab" data-tab="close">‡πÄ‡∏Ç‡∏ï‡∏™‡∏π‡∏™‡∏µ</div>
                <div class="tab" data-tab="benford">Benford's Law</div>
                <div class="tab" data-tab="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ú‡∏π‡∏Å‡∏Ç‡∏≤‡∏î</div>
                <div class="tab" data-tab="math">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á</div>
                <div class="tab" data-tab="counting">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏ö</div>
            </div>

            <!-- Tab: Turnout -->
            <div class="tab-panel active" id="panel-turnout">
                <h3>üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</h3>
                <div class="grid2">
                    <div>
                        <div class="chart-container"><canvas id="turnoutHist"></canvas></div>
                        <div id="turnoutStats"></div>
                    </div>
                    <div>
                        <div class="chart-container"><canvas id="turnoutScatter"></canvas></div>
                    </div>
                </div>
                <h3>üö© ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Outliers)</h3>
                <div class="table-responsive" id="turnoutTable"></div>
            </div>

            <!-- Tab: Invalid -->
            <div class="tab-panel" id="panel-invalid">
                <h3>üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢</h3>
                <div class="grid2">
                    <div><div class="chart-container"><canvas id="invalidHist"></canvas></div><div id="invalidStats"></div></div>
                    <div><div class="chart-container"><canvas id="invalidBar"></canvas></div></div>
                </div>
                <h3>üö© ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</h3>
                <div class="table-responsive" id="invalidTable"></div>
            </div>

            <!-- Tab: Blank -->
            <div class="tab-panel" id="panel-blank">
                <h3>üìä ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                <div class="grid2">
                    <div><div class="chart-container"><canvas id="blankHist"></canvas></div><div id="blankStats"></div></div>
                    <div><div class="chart-container"><canvas id="blankBar"></canvas></div></div>
                </div>
                <h3>üö© ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø ‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</h3>
                <div class="table-responsive" id="blankTable"></div>
            </div>

            <!-- Tab: Wasted -->
            <div class="tab-panel" id="panel-wasted">
                <h3>üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ + ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø)</h3>
                <div class="grid2">
                    <div><div class="chart-container"><canvas id="wastedHist"></canvas></div><div id="wastedStats"></div></div>
                    <div><div class="chart-container"><canvas id="wastedBar"></canvas></div></div>
                </div>
                <h3>üö© ‡πÄ‡∏Ç‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏π‡∏á</h3>
                <div class="table-responsive" id="wastedTable"></div>
            </div>

            <!-- Tab: Dominance -->
            <div class="tab-panel" id="panel-dominance">
                <h3>üìä ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (% ‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ)</h3>
                <div class="grid2">
                    <div><div class="chart-container"><canvas id="domHist"></canvas></div></div>
                    <div><div class="chart-container"><canvas id="domParty"></canvas></div></div>
                </div>
                <h3>üö© ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô >60%</h3>
                <div class="table-responsive" id="domTable"></div>
            </div>

            <!-- Tab: Close races -->
            <div class="tab-panel" id="panel-close">
                <h3>‚öîÔ∏è ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏™‡∏π‡∏™‡∏µ (margin &lt;3%)</h3>
                <div class="chart-container chart-sm"><canvas id="closeChart"></canvas></div>
                <div class="table-responsive" id="closeTable"></div>
            </div>

            <!-- Tab: Benford -->
            <div class="tab-panel" id="panel-benford">
                <h3>üî¢ Benford's Law ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h3>
                <div id="benfordVerdict"></div>
                <div class="grid2">
                    <div><div class="chart-container"><canvas id="benfordChart"></canvas></div></div>
                    <div><div class="chart-container"><canvas id="benfordDev"></canvas></div></div>
                </div>
                <div id="benfordExplain" style="margin-top:12px;font-size:.9em;color:#555;line-height:1.6;"></div>
            </div>

            <!-- Tab: Province patterns -->
            <div class="tab-panel" id="panel-province">
                <h3>üó∫Ô∏è ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ä‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</h3>
                <div class="chart-container"><canvas id="monopolyChart"></canvas></div>
                <div class="table-responsive" id="monopolyTable"></div>
            </div>

            <!-- Tab: Math consistency -->
            <div class="tab-panel" id="panel-math">
                <h3>üßÆ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</h3>
                <div id="mathVerdict"></div>
                <div id="mathDetail"></div>
            </div>

            <!-- Tab: Counting -->
            <div class="tab-panel" id="panel-counting">
                <h3>‚è≥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                <div id="countingStats"></div>
                <h3>üö© ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Paused)</h3>
                <div class="table-responsive" id="pausedTable"></div>
                <h3>‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                <div class="table-responsive" id="incompleteTable"></div>
            </div>
        </div>

        <!-- All flags summary -->
        <div class="section">
            <h2>üö© ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Flag ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div class="table-responsive" id="allFlagsTable"></div>
        </div>
    </div>

    <div class="footer">
        <p>Election Verification System ‚Äî ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏Å‡∏ï.</p>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å <a href="https://ectreport69.ect.go.th" target="_blank">‡∏Å‡∏Å‡∏ï.</a></p>
    </div>

    <script>
    let AD = null; // anomaly data
    const charts = {};

    document.addEventListener('DOMContentLoaded', () => {
        fetch('data/anomaly_data.json')
            .then(r => r.json())
            .then(d => { AD = d; render(); })
            .catch(e => { document.getElementById('execSummary').innerHTML = '<p style="color:red">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e.message+'</p>'; });

        // Tab switching
        document.getElementById('mainTabs').addEventListener('click', e => {
            if (!e.target.classList.contains('tab')) return;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById('panel-' + e.target.dataset.tab).classList.add('active');
        });
    });

    function render() {
        renderSummary();
        renderTurnout();
        renderInvalid();
        renderBlank();
        renderWasted();
        renderDominance();
        renderClose();
        renderBenford();
        renderProvince();
        renderMath();
        renderCounting();
        renderAllFlags();
    }

    // ‚ïê‚ïê‚ïê Summary ‚ïê‚ïê‚ïê
    function renderSummary() {
        const m = AD.metadata;
        const t = AD.turnout.summary, inv = AD.invalid_ballots.summary, bl = AD.blank_votes.summary;
        const dom = AD.winner_dominance.summary, cl = AD.close_races.summary;
        const bf = AD.benford.summary, prov = AD.province_patterns;

        let html = `
            <div class="s-card"><div class="lbl">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="num">${m.total_units}</div></div>
            <div class="s-card red"><div class="lbl">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å flag</div><div class="num">${m.flagged_units}</div><div class="lbl">${(m.flagged_units/m.total_units*100).toFixed(1)}%</div></div>
            <div class="s-card orange"><div class="lbl">Turnout ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="num">${t.outlier_count}</div></div>
            <div class="s-card orange"><div class="lbl">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏π‡∏á</div><div class="num">${inv.outlier_count}</div></div>
            <div class="s-card orange"><div class="lbl">‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø ‡∏™‡∏π‡∏á</div><div class="num">${bl.outlier_count}</div></div>
            <div class="s-card red"><div class="lbl">‡∏ä‡∏ô‡∏∞‡∏Ç‡∏≤‡∏î‡∏•‡∏≠‡∏¢ >60%</div><div class="num">${dom.extreme_count}</div></div>
            <div class="s-card blue"><div class="lbl">‡πÄ‡∏Ç‡∏ï‡∏™‡∏π‡∏™‡∏µ <3%</div><div class="num">${cl.total_close}</div></div>
            <div class="s-card ${bf.passes_test?'green':'red'}"><div class="lbl">Benford's Law</div><div class="num">${bf.passes_test?'‡∏ú‡πà‡∏≤‡∏ô':'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</div></div>
            <div class="s-card orange"><div class="lbl">‡∏à‡∏ß.‡∏ú‡∏π‡∏Å‡∏Ç‡∏≤‡∏î</div><div class="num">${prov.monopoly.length}</div></div>
        `;
        document.getElementById('summaryCards').innerHTML = html;

        // Verdict
        let vhtml = '';
        if (m.flagged_units > m.total_units * 0.3) {
            vhtml += '<div class="verdict fail">üö® ‡∏û‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ >30% ‚Äî ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>';
        } else if (m.flagged_units > m.total_units * 0.1) {
            vhtml += '<div class="verdict warn">‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ '+m.flagged_units+' ‡πÄ‡∏Ç‡∏ï ('+((m.flagged_units/m.total_units*100).toFixed(1))+'%) ‚Äî ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</div>';
        }
        if (!bf.passes_test) {
            vhtml += '<div class="verdict fail">üö® ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <strong>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</strong> Benford\'s Law (œá¬≤='+bf.chi_square+' > ‡πÄ‡∏Å‡∏ì‡∏ë‡πå '+bf.chi_critical_005+') ‚Äî ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</div>';
        }
        if (prov.monopoly.length > 10) {
            vhtml += '<div class="verdict warn">‚ö†Ô∏è ‡∏û‡∏ö '+prov.monopoly.length+' ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ä‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï ‚Äî ‡∏≠‡∏≤‡∏à‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Ç‡πà‡∏≤‡∏¢‡∏≠‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏•</div>';
        }
        document.getElementById('verdictArea').innerHTML = vhtml;
    }

    // ‚ïê‚ïê‚ïê Turnout ‚ïê‚ïê‚ïê
    function renderTurnout() {
        const s = AD.turnout.summary, dist = AD.turnout.distribution;
        makeHistChart('turnoutHist', dist, '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥', '#667eea');
        // Scatter: turnout vs registered
        const all = AD.turnout.all;
        makeChart('turnoutScatter', 'scatter', {
            datasets: [{
                label: '‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á',
                data: all.map(t => ({x: t.registered, y: t.turnout_pct, label: t.constituency})),
                backgroundColor: all.map(t => t.is_outlier ? '#f5576c' : 'rgba(102,126,234,.4)'),
                pointRadius: all.map(t => t.is_outlier ? 5 : 3),
            }]
        }, {
            plugins: {title:{display:true,text:'Turnout % vs ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥'}},
            scales:{x:{title:{display:true,text:'‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ (‡∏Ñ‡∏ô)'}},y:{title:{display:true,text:'Turnout %'}}}
        });

        let stats = `<div class="stat-box"><span class="key">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span class="val">${s.mean}%</span></div>
            <div class="stat-box"><span class="key">‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏ê‡∏≤‡∏ô:</span> <span class="val">${s.median}%</span></div>
            <div class="stat-box"><span class="key">‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô:</span> <span class="val">${s.stdev}%</span></div>
            <div class="stat-box"><span class="key">‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏•‡πà‡∏≤‡∏á (Q1-1.5√óIQR):</span> <span class="val">${s.lower_fence}%</span></div>
            <div class="stat-box"><span class="key">‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ö‡∏ô (Q3+1.5√óIQR):</span> <span class="val">${s.upper_fence}%</span></div>`;
        document.getElementById('turnoutStats').innerHTML = stats;

        let tbl = '<table><thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>Turnout</th><th>‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</th><th>‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</th><th>Z-score</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>';
        AD.turnout.outliers.forEach(t => {
            tbl += `<tr><td>${t.constituency}</td><td>${t.province}</td><td><strong>${t.turnout_pct}%</strong></td>
                <td>${t.registered.toLocaleString()}</td><td>${t.came.toLocaleString()}</td>
                <td>${t.z_score}</td><td><span class="badge ${Math.abs(t.z_score)>3?'badge-high':'badge-medium'}">${t.flag}</span></td></tr>`;
        });
        tbl += '</tbody></table>';
        document.getElementById('turnoutTable').innerHTML = tbl;
    }

    // ‚ïê‚ïê‚ïê Invalid ‚ïê‚ïê‚ïê
    function renderInvalid() {
        const s = AD.invalid_ballots.summary, dist = AD.invalid_ballots.distribution;
        makeHistChart('invalidHist', dist, '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ (%)', '#ff6b6b');
        // Top outliers bar
        const top = AD.invalid_ballots.outliers.slice(0, 15);
        makeChart('invalidBar', 'bar', {
            labels: top.map(t => t.constituency.replace(/\s*‡πÄ‡∏Ç‡∏ï\s*/, ' ').substring(0,20)),
            datasets: [{label:'‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ %', data: top.map(t=>t.invalid_rate), backgroundColor:'#ff6b6b'}]
        }, {indexAxis:'y',plugins:{legend:{display:false},title:{display:true,text:'‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'}},scales:{x:{beginAtZero:true}}});

        let stats = `<div class="stat-box"><span class="key">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span class="val">${s.mean}%</span></div>
            <div class="stat-box"><span class="key">‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ö‡∏ô (Q3+1.5√óIQR):</span> <span class="val">${s.upper_fence}%</span></div>
            <div class="stat-box"><span class="key">Outlier:</span> <span class="val">${s.outlier_count} ‡πÄ‡∏Ç‡∏ï</span></div>`;
        document.getElementById('invalidStats').innerHTML = stats;

        document.getElementById('invalidTable').innerHTML = makeOutlierTable(AD.invalid_ballots.outliers,
            ['constituency','province','invalid_rate','invalid_votes','turn_out','z_score','flag'],
            ['‡πÄ‡∏Ç‡∏ï','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î','‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ %','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥','Z-score','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'], 'invalid_rate');
    }

    // ‚ïê‚ïê‚ïê Blank ‚ïê‚ïê‚ïê
    function renderBlank() {
        const dist = AD.blank_votes.distribution, s = AD.blank_votes.summary;
        makeHistChart('blankHist', dist, '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø (%)', '#ffa726');
        const top = AD.blank_votes.outliers.slice(0, 15);
        makeChart('blankBar', 'bar', {
            labels: top.map(t => t.constituency.replace(/\s*‡πÄ‡∏Ç‡∏ï\s*/, ' ').substring(0,20)),
            datasets: [{label:'‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø %', data: top.map(t=>t.blank_rate), backgroundColor:'#ffa726'}]
        }, {indexAxis:'y',plugins:{legend:{display:false},title:{display:true,text:'‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'}},scales:{x:{beginAtZero:true}}});

        let stats = `<div class="stat-box"><span class="key">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span class="val">${s.mean}%</span></div>
            <div class="stat-box"><span class="key">‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ö‡∏ô:</span> <span class="val">${s.upper_fence}%</span></div>
            <div class="stat-box"><span class="key">Outlier:</span> <span class="val">${s.outlier_count} ‡πÄ‡∏Ç‡∏ï</span></div>`;
        document.getElementById('blankStats').innerHTML = stats;
        document.getElementById('blankTable').innerHTML = makeOutlierTable(AD.blank_votes.outliers,
            ['constituency','province','blank_rate','blank_votes','turn_out','z_score','flag'],
            ['‡πÄ‡∏Ç‡∏ï','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î','‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø %','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥','Z-score','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'], 'blank_rate');
    }

    // ‚ïê‚ïê‚ïê Wasted ‚ïê‚ïê‚ïê
    function renderWasted() {
        const dist = AD.wasted_votes.distribution, s = AD.wasted_votes.summary;
        makeHistChart('wastedHist', dist, '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤ (%)', '#7e57c2');
        const top = AD.wasted_votes.outliers.slice(0, 15);
        makeChart('wastedBar', 'bar', {
            labels: top.map(t => t.constituency.replace(/\s*‡πÄ‡∏Ç‡∏ï\s*/, ' ').substring(0,20)),
            datasets: [{label:'‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤ %', data: top.map(t=>t.wasted_rate), backgroundColor:'#7e57c2'}]
        }, {indexAxis:'y',plugins:{legend:{display:false},title:{display:true,text:'‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'}},scales:{x:{beginAtZero:true}}});

        let stats = `<div class="stat-box"><span class="key">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span class="val">${s.mean}%</span></div>
            <div class="stat-box"><span class="key">‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ö‡∏ô:</span> <span class="val">${s.upper_fence}%</span></div>
            <div class="stat-box"><span class="key">Outlier:</span> <span class="val">${s.outlier_count} ‡πÄ‡∏Ç‡∏ï</span></div>`;
        document.getElementById('wastedStats').innerHTML = stats;
        document.getElementById('wastedTable').innerHTML = makeOutlierTable(AD.wasted_votes.outliers,
            ['constituency','province','wasted_rate','wasted_votes','invalid_votes','blank_votes','turn_out','flag'],
            ['‡πÄ‡∏Ç‡∏ï','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î','‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤ %','‡∏£‡∏ß‡∏°','‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢','‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø','‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'], 'wasted_rate');
    }

    // ‚ïê‚ïê‚ïê Dominance ‚ïê‚ïê‚ïê
    function renderDominance() {
        const dist = AD.winner_dominance.distribution;
        makeHistChart('domHist', dist, '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (% ‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ)', '#42a5f5');

        // Party breakdown of extreme winners
        const ext = AD.winner_dominance.extreme;
        const partyCounts = {};
        ext.forEach(e => { partyCounts[e.winner] = (partyCounts[e.winner]||0)+1; });
        const parties = Object.entries(partyCounts).sort((a,b)=>b[1]-a[1]);
        makeChart('domParty', 'doughnut', {
            labels: parties.map(p=>p[0]),
            datasets: [{data: parties.map(p=>p[1]), backgroundColor:['#fd6512','#0c149c','#e02020','#06aff3','#ffc107','#28a745','#764ba2','#999']}]
        }, {plugins:{title:{display:true,text:'‡∏û‡∏£‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡∏Ç‡∏≤‡∏î‡∏•‡∏≠‡∏¢ (>60%) ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏£‡∏£‡∏Ñ'}}});

        let tbl = '<table><thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô %</th><th>Margin</th><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2</th></tr></thead><tbody>';
        ext.forEach(e => {
            tbl += `<tr><td>${e.constituency}</td><td>${e.province}</td>
                <td><span style="color:${e.winner_color};font-weight:600">${e.winner}</span></td>
                <td><strong>${e.winner_pct}%</strong></td><td>${e.margin}%</td><td>${e.runner_up}</td></tr>`;
        });
        tbl += '</tbody></table>';
        document.getElementById('domTable').innerHTML = tbl;
    }

    // ‚ïê‚ïê‚ïê Close Races ‚ïê‚ïê‚ïê
    function renderClose() {
        const races = AD.close_races.close_races;
        makeChart('closeChart', 'bar', {
            labels: races.map(r => r.constituency.replace(/\s*‡πÄ‡∏Ç‡∏ï\s*/, ' ').substring(0,18)),
            datasets: [{label:'Margin %', data: races.map(r=>r.margin_pct), backgroundColor: races.map(r=>r.margin_pct<1?'#f5576c':'#ffc107')}]
        }, {plugins:{title:{display:true,text:'‡πÄ‡∏Ç‡∏ï‡∏™‡∏π‡∏™‡∏µ ‚Äî margin %'}},scales:{y:{beginAtZero:true}}});

        let tbl = '<table><thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>Margin</th><th>‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th></tr></thead><tbody>';
        races.forEach(r => {
            tbl += `<tr><td>${r.constituency}</td><td>${r.province}</td>
                <td><strong>${r.winner}</strong><br><small>${r.winner_name}</small></td><td>${r.winner_votes.toLocaleString()}</td>
                <td>${r.runner_up}<br><small>${r.runner_up_name}</small></td><td>${r.runner_up_votes.toLocaleString()}</td>
                <td><strong>${r.margin_pct}%</strong><br>(${r.margin_votes.toLocaleString()} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</td>
                <td>${r.counted_pct.toFixed(1)}%</td></tr>`;
        });
        tbl += '</tbody></table>';
        document.getElementById('closeTable').innerHTML = tbl;
    }

    // ‚ïê‚ïê‚ïê Benford ‚ïê‚ïê‚ïê
    function renderBenford() {
        const bf = AD.benford, digits = bf.digits;
        makeChart('benfordChart', 'bar', {
            labels: digits.map(d=>''+d.digit),
            datasets: [
                {label:'‡∏û‡∏ö‡∏à‡∏£‡∏¥‡∏á %', data: digits.map(d=>d.observed_pct), backgroundColor:'rgba(102,126,234,.7)'},
                {label:'‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á (Benford) %', data: digits.map(d=>d.expected_pct), backgroundColor:'rgba(245,87,108,.5)'}
            ]
        }, {plugins:{title:{display:true,text:'Benford\'s Law ‚Äî ‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£'}},scales:{y:{beginAtZero:true,title:{display:true,text:'%'}},x:{title:{display:true,text:'‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏£‡∏Å'}}}});

        makeChart('benfordDev', 'bar', {
            labels: digits.map(d=>''+d.digit),
            datasets: [{label:'‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô %', data: digits.map(d=>d.deviation), backgroundColor: digits.map(d=>Math.abs(d.deviation)>2?'#f5576c':'#667eea')}]
        }, {plugins:{title:{display:true,text:'‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏à‡∏≤‡∏Å Benford\'s Law'}},scales:{y:{title:{display:true,text:'‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô (%)'}},x:{title:{display:true,text:'‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏£‡∏Å'}}}});

        const v = bf.summary;
        document.getElementById('benfordVerdict').innerHTML = v.passes_test
            ? '<div class="verdict pass">‚úÖ <strong>‡∏ú‡πà‡∏≤‡∏ô</strong> Benford\'s Law ‚Äî ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (œá¬≤='+v.chi_square+' < '+v.chi_critical_005+')</div>'
            : '<div class="verdict fail">‚ùå <strong>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</strong> Benford\'s Law ‚Äî ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (œá¬≤='+v.chi_square+' > '+v.chi_critical_005+')</div>';

        document.getElementById('benfordExplain').innerHTML = `
            <strong>Benford's Law ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</strong><br>
            ‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏•‡∏Ç 1 ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏£‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (~30.1%) ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç 9 ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (~4.6%)
            ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏à‡∏≤‡∏Å Benford's Law ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏≠‡∏≤‡∏à‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡∏≠‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç<br><br>
            <strong>‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</strong> ‡πÉ‡∏ä‡πâ Chi-square test ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏à‡∏£‡∏¥‡∏á vs ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏à‡∏≤‡∏Å Benford's Law
            ‡∏Ñ‡πà‡∏≤ œá¬≤ = ${v.chi_square} ${v.passes_test ? '< ' : '> '} ${v.chi_critical_005} (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà Œ±=0.05, df=8)<br>
            <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</strong> ${v.total_values.toLocaleString()} ‡∏Ñ‡πà‡∏≤
        `;
    }

    // ‚ïê‚ïê‚ïê Province ‚ïê‚ïê‚ïê
    function renderProvince() {
        const mono = AD.province_patterns.monopoly;
        makeChart('monopolyChart', 'bar', {
            labels: mono.map(m=>m.province),
            datasets: [{label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡∏ï', data: mono.map(m=>m.total_cons), backgroundColor: mono.map(m=>'#f5576c')}]
        }, {plugins:{title:{display:true,text:'‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ä‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï'}},scales:{y:{beginAtZero:true}}});

        let tbl = '<table><thead><tr><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡∏û‡∏£‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞</th><th>Turnout ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th></tr></thead><tbody>';
        mono.forEach(m => {
            tbl += `<tr><td><strong>${m.province}</strong></td><td>${m.total_cons}</td>
                <td><strong>${m.dominant_party}</strong></td><td>${m.avg_turnout}%</td><td>${m.avg_invalid_rate}%</td></tr>`;
        });
        tbl += '</tbody></table>';
        document.getElementById('monopolyTable').innerHTML = tbl;
    }

    // ‚ïê‚ïê‚ïê Math ‚ïê‚ïê‚ïê
    function renderMath() {
        const mc = AD.math_consistency;
        let v = '';
        if (mc.summary.turnout_math_errors === 0 && mc.summary.candidate_sum_errors === 0) {
            v = '<div class="verdict pass">‚úÖ <strong>‡∏ú‡πà‡∏≤‡∏ô</strong> ‚Äî ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</div>';
        } else {
            v = '<div class="verdict fail">‚ùå ‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á ‚Äî Turnout errors: '+mc.summary.turnout_math_errors+', Candidate sum errors: '+mc.summary.candidate_sum_errors+'</div>';
        }
        document.getElementById('mathVerdict').innerHTML = v;

        let detail = `<div class="stat-box"><span class="key">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 1:</span> <span class="val">‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ + ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ + ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø = ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ ‚Üí ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${mc.summary.turnout_math_errors} ‡πÄ‡∏Ç‡∏ï</span></div>
            <div class="stat-box"><span class="key">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 2:</span> <span class="val">‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ = ‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ ‚Üí ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${mc.summary.candidate_sum_errors} ‡πÄ‡∏Ç‡∏ï</span></div>`;

        if (mc.candidate_sum_errors.length > 0) {
            detail += '<h3 style="margin-top:16px">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á</h3><table><thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ</th><th>‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th><th>‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th></tr></thead><tbody>';
            mc.candidate_sum_errors.forEach(e => {
                detail += `<tr><td>${e.constituency}</td><td>${e.valid_votes.toLocaleString()}</td><td>${e.candidate_sum.toLocaleString()}</td><td>${e.difference.toLocaleString()}</td></tr>`;
            });
            detail += '</tbody></table>';
        }
        document.getElementById('mathDetail').innerHTML = detail;
    }

    // ‚ïê‚ïê‚ïê Counting ‚ïê‚ïê‚ïê
    function renderCounting() {
        const cp = AD.counting_progress;
        let stats = `<div class="stat-box"><span class="key">‡∏ô‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö 100%:</span> <span class="val">${cp.summary.complete} ‡πÄ‡∏Ç‡∏ï</span></div>
            <div class="stat-box"><span class="key">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö:</span> <span class="val">${cp.summary.incomplete} ‡πÄ‡∏Ç‡∏ï</span></div>
            <div class="stat-box"><span class="key">‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</span> <span class="val">${cp.summary.paused} ‡πÄ‡∏Ç‡∏ï</span></div>`;
        document.getElementById('countingStats').innerHTML = stats;

        if (cp.paused.length > 0) {
            let tbl = '<table><thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>%</th></tr></thead><tbody>';
            cp.paused.forEach(p => {
                tbl += `<tr><td>${p.constituency}</td><td>${p.province}</td><td>${p.counted_stations}</td><td>${p.total_stations}</td><td>${p.percent_count}%</td></tr>`;
            });
            tbl += '</tbody></table>';
            document.getElementById('pausedTable').innerHTML = tbl;
        } else {
            document.getElementById('pausedTable').innerHTML = '<p style="color:var(--muted)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>';
        }

        let tbl2 = '<table><thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</th><th>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>%</th></tr></thead><tbody>';
        cp.most_incomplete.forEach(p => {
            tbl2 += `<tr><td>${p.constituency}</td><td>${p.province}</td><td>${p.counted_stations}</td><td>${p.total_stations}</td><td>${p.remaining}</td><td>${p.percent_count}%</td></tr>`;
        });
        tbl2 += '</tbody></table>';
        document.getElementById('incompleteTable').innerHTML = tbl2;
    }

    // ‚ïê‚ïê‚ïê All flags ‚ïê‚ïê‚ïê
    function renderAllFlags() {
        const flags = AD.all_flags.sort((a,b) => b.severity === 'high' ? 1 : -1);
        let tbl = '<table><thead><tr><th>‡πÄ‡∏Ç‡∏ï</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th></tr></thead><tbody>';
        flags.forEach(f => {
            const catMap = {turnout:'Turnout',invalid:'‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢',blank:'‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ø',wasted:'‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤',dominance:'‡∏ä‡∏ô‡∏∞‡∏Ç‡∏≤‡∏î‡∏•‡∏≠‡∏¢'};
            tbl += `<tr><td>${f.constituency}</td><td>${f.province}</td>
                <td>${catMap[f.category]||f.category}</td><td>${f.detail}</td>
                <td><span class="badge badge-${f.severity}">${f.severity==='high'?'‡∏™‡∏π‡∏á':'‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'}</span></td></tr>`;
        });
        tbl += '</tbody></table>';
        document.getElementById('allFlagsTable').innerHTML = tbl;
    }

    // ‚ïê‚ïê‚ïê Chart helpers ‚ïê‚ïê‚ïê
    function makeHistChart(id, dist, label, color) {
        makeChart(id, 'bar', {
            labels: dist.labels,
            datasets: [{label: label, data: dist.counts, backgroundColor: color}]
        }, {plugins:{legend:{display:false},title:{display:true,text:label}},scales:{y:{beginAtZero:true,title:{display:true,text:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡∏ï'}}}});
    }

    function makeChart(id, type, data, options) {
        if (charts[id]) charts[id].destroy();
        const ctx = document.getElementById(id);
        if (!ctx) return;
        charts[id] = new Chart(ctx.getContext('2d'), {
            type, data, options: Object.assign({responsive:true,maintainAspectRatio:false}, options||{})
        });
    }

    function makeOutlierTable(items, keys, headers, highlightKey) {
        let tbl = '<table><thead><tr>' + headers.map(h=>'<th>'+h+'</th>').join('') + '</tr></thead><tbody>';
        items.forEach(item => {
            tbl += '<tr>';
            keys.forEach(k => {
                let v = item[k];
                if (typeof v === 'number' && !Number.isInteger(v)) v = v.toFixed(2);
                if (typeof v === 'number' && v > 999) v = v.toLocaleString();
                if (k === highlightKey) v = '<strong>'+v+'%</strong>';
                if (k === 'flag') v = '<span class="badge badge-medium">'+v+'</span>';
                tbl += '<td>'+v+'</td>';
            });
            tbl += '</tr>';
        });
        tbl += '</tbody></table>';
        return tbl;
    }
    </script>
</body>
</html>
